<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <title>kiwiLAB | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { --kiwi-red: #ef4444; --kiwi-red-dark: #b91c1c; }
        * { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body { font-family: 'Inter', sans-serif; background: #ffffff; color: #0f172a; min-height: 100vh; }
        .dark body { background: #050505; color: #ffffff; }

        nav { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 100; }
        .dark nav { background: rgba(5,5,5,0.7); border-bottom: 1px solid rgba(255,255,255,0.03); }

        /* INPUTS Y BUSCADOR (FIX FOCUS) */
        input:not([type="button"]):not([type="submit"]) { 
            background: rgba(0,0,0,0.04) !important; border: none !important; padding: 12px 18px !important; border-radius: 12px !important; font-size: 13px !important; width: 100%; outline: none !important; color: inherit;
        }
        .dark input:not([type="button"]):not([type="submit"]) { background: rgba(255,255,255,0.04) !important; color: #94a3b8; }
        
        /* Efecto Focus Recuperado */
        input:not([type="button"]):not([type="submit"]):focus { 
            background: rgba(239, 68, 68, 0.02) !important; 
            box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.3), 0 0 20px rgba(239, 68, 68, 0.05) !important;
        }

        .search-container { position: relative; width: 100%; max-width: 400px; }
        #global-search { padding-left: 45px !important; }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; opacity: 0.3; pointer-events: none; z-index: 10; }

        /* GRID Y CARDS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1.8rem; padding: 3rem; }
        .card {
            aspect-ratio: 1/1; border-radius: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; 
            background: #f1f5f9; border: 1px solid rgba(0,0,0,0.02);
        }
        .dark .card { background: #111113; border: 1px solid rgba(255,255,255,0.02); }
        .card:hover { transform: translateY(-8px); border-color: var(--kiwi-red); background: #e2e8f0; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.05); }
        .dark .card:hover { background: #161618; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); }

        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(-1.2deg); } 75% { transform: rotate(1.2deg); } 100% { transform: rotate(0deg); } }
        body.editing .card { animation: shake 0.3s infinite ease-in-out; border: 2px dashed var(--kiwi-red) !important; }

        /* ACCIONES EDICIÓN */
        .action-btn { display: none; position: absolute; width: 26px; height: 26px; border-radius: 50%; color: white; align-items: center; justify-content: center; font-size: 10px; z-index: 100; border: 2px solid #fff; }
        .dark .action-btn { border-color: #111113; }
        body.editing .action-btn { display: flex; }
        .del-btn { top: -8px; right: -8px; background: #ef4444; }
        .edit-item-btn { top: -8px; left: -8px; background: #3b82f6; }

        /* MODALES */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
        .dark .modal-overlay { background: rgba(0,0,0,0.8); }
        .modal-box { width: 100%; max-width: 400px; border-radius: 2.2rem; background: #fff; padding: 2.5rem; }
        .dark .modal-box { background: #0f0f11; border: 1px solid rgba(255,255,255,0.03); }

        /* BOTONES (ROJO RECUPERADO) */
        .btn-kiwi-red {
            background: linear-gradient(135deg, var(--kiwi-red), var(--kiwi-red-dark)) !important;
            color: white !important; font-weight: 800 !important; text-transform: uppercase !important;
            box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.4) !important;
            border-radius: 12px !important; padding: 14px !important; width: 100%; font-size: 10px !important; letter-spacing: 0.1em !important; border: none !important;
        }
        .btn-kiwi-red:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(239, 68, 68, 0.6) !important; opacity: 1 !important; }

        .btn-close { 
            background: transparent !important; color: #94a3b8 !important; font-size: 10px !important; font-weight: 800 !important; text-transform: uppercase !important; letter-spacing: 2px !important; text-align: center !important; display: block !important; cursor: pointer !important; width: 100%; margin-top: 1rem; border: none !important;
        }
        .btn-close:hover { color: var(--kiwi-red) !important; }

        .label-style { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.2em; opacity: 0.4; margin-bottom: 6px; display: block; }
        .icon-list-grid { background: rgba(0,0,0,0.03); border-radius: 12px; padding: 10px; max-height: 120px; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
        .dark .icon-list-grid { background: rgba(255,255,255,0.02); }
        .icon-opt { border-radius: 10px; padding: 8px; display: flex; justify-content: center; cursor: pointer; }
        .icon-opt:hover { background: var(--kiwi-red); transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">

    <nav class="p-5 flex justify-between items-center px-10">
        <div class="flex items-center gap-4 w-1/4">
            <div class="w-11 h-11 bg-red-600 rounded-[14px] flex items-center justify-center font-black text-white italic shadow-lg shadow-red-600/30">K</div>
            <div>
                <div class="flex items-center gap-2">
                    <h1 class="text-lg font-black uppercase italic tracking-tighter leading-none">kiwiLAB</h1>
                    <a href="https://github.com/kiwinh0/kiwilab" target="_blank" class="opacity-30 hover:opacity-100 hover:text-red-500 transition-opacity">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"></path></svg>
                    </a>
                </div>
                <p class="text-[9px] font-bold uppercase tracking-[0.3em] opacity-30">Dashboard</p>
            </div>
        </div>

        <div class="search-container">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3"></path></svg>
            <input type="text" id="global-search" placeholder="Buscar servicios..." oninput="filterDashboard(this.value)">
        </div>

        <div class="flex gap-3 w-1/4 justify-end">
            <button id="add-btn-nav" onclick="openModal('add')" class="hidden btn-kiwi-red !py-2.5 !px-5 !w-auto">＋</button>
            <button onclick="document.documentElement.classList.toggle('dark')" class="w-11 h-11 rounded-xl border border-zinc-200 dark:border-zinc-800 flex items-center justify-center text-zinc-400 hover:text-red-500 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9 9 0 0012 21a9 9 0 008.354-5.646z" stroke-width="2"></path></svg>
            </button>
            <button onclick="toggleEditMode()" class="w-11 h-11 rounded-xl border border-zinc-200 dark:border-zinc-800 flex items-center justify-center text-zinc-400 hover:text-red-500">
                <svg id="pencil-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"></path></svg>
                <span id="check-icon" class="hidden font-bold text-emerald-500 text-lg">✓</span>
            </button>
        </div>
    </nav>

    <main class="dashboard-grid" id="main-grid">
        {{range .}}
        <div class="card" id="card-{{.ID}}" data-id="{{.ID}}" data-title="{{.Title}}" onclick="if(!isEditing) window.open('{{.URL}}', '_blank')">
            <button class="action-btn del-btn" onclick="event.stopPropagation(); confirmDelete('{{.ID}}', '{{.Title}}')">✕</button>
            <button class="action-btn edit-item-btn" onclick="event.stopPropagation(); openModal('edit', {id:'{{.ID}}', title:'{{.Title}}', url:'{{.URL}}', icon:'{{.Icon}}'})">✎</button>
            <img src="https://raw.githubusercontent.com/selfhst/icons/main/webp/{{.Icon}}.webp" class="w-16 h-16 mb-4 object-contain" onerror="this.src='https://api.lucide.dev/icons/box/48/444.png'">
            <span class="text-[10px] font-bold uppercase opacity-40 tracking-[0.2em] text-center px-2">{{.Title}}</span>
        </div>
        {{end}}
    </main>

    <div id="modal" class="hidden modal-overlay">
        <div class="modal-box">
            <form id="modal-form" method="POST" class="flex flex-col gap-6">
                <input type="hidden" name="id" id="form-id">
                <h2 class="text-center font-black italic uppercase text-[10px] tracking-[0.3em] opacity-40">Configurar Marcador</h2>
                <div class="space-y-4">
                    <div><label class="label-style">Nombre</label><input type="text" name="title" id="form-title" placeholder="Ej: Plex" required autocomplete="off"></div>
                    <div><label class="label-style">URL</label><input type="url" name="url" id="form-url" placeholder="https://..." required autocomplete="off"></div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="label-style">Icono</label>
                            <span class="text-[8px] font-black text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded-full uppercase">ONLINE</span>
                        </div>
                        <input type="text" id="icon-search" autocomplete="off" placeholder="Buscar icono...">
                        <div class="icon-list-grid" id="icon-results"></div>
                        <input type="hidden" name="icon" id="form-icon-val" required>
                    </div>
                </div>
                <div class="pt-2">
                    <button type="submit" class="btn-kiwi-red">Guardar Cambios</button>
                    <button type="button" onclick="closeModal('modal')" class="btn-close">Cerrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="hidden modal-overlay">
        <div class="modal-box text-center">
            <div class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"></path></svg>
            </div>
            <h3 class="font-black uppercase text-xs tracking-widest mb-2">¿Eliminar marcador?</h3>
            <p id="delete-name" class="text-[11px] opacity-50 mb-8 px-4"></p>
            <div class="flex flex-col gap-2">
                <button id="confirm-delete-btn" class="btn-kiwi-red">Confirmar Eliminación</button>
                <button type="button" onclick="closeModal('confirm-modal')" class="btn-close">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let isEditing = false;
        let iconDatabase = [];
        let sortableInstance;
        let pendingDeleteId = null;

        function filterDashboard(query) {
            const cards = document.querySelectorAll('.card');
            const q = query.toLowerCase();
            cards.forEach(card => {
                const title = (card.getAttribute('data-title') || "").toLowerCase();
                card.classList.toggle('hidden-card', !title.includes(q));
            });
        }

        const grid = document.getElementById('main-grid');
        sortableInstance = new Sortable(grid, {
            animation: 250, disabled: true,
            onEnd: async function() {
                const ids = Array.from(grid.querySelectorAll('.card')).map(card => card.dataset.id);
                await fetch('/reorder-bookmarks', { method: 'POST', body: 'ids=' + ids.join(','), headers: { 'Content-Type': 'application/x-www-form-urlencoded' }});
            }
        });

        function toggleEditMode() {
            isEditing = !isEditing;
            document.body.classList.toggle('editing', isEditing);
            document.getElementById('pencil-icon').classList.toggle('hidden', isEditing);
            document.getElementById('check-icon').classList.toggle('hidden', !isEditing);
            document.getElementById('add-btn-nav').classList.toggle('hidden', !isEditing);
            sortableInstance.option('disabled', !isEditing);
        }

        function confirmDelete(id, name) {
            pendingDeleteId = id;
            document.getElementById('delete-name').innerText = `Estás a punto de borrar "${name}".`;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        document.getElementById('confirm-delete-btn').onclick = async () => {
            if(!pendingDeleteId) return;
            await fetch('/delete-bookmark', { method: 'POST', body: 'id='+pendingDeleteId, headers: {'Content-Type': 'application/x-www-form-urlencoded'}});
            document.getElementById('card-'+pendingDeleteId).remove();
            closeModal('confirm-modal');
            pendingDeleteId = null;
        };

        fetch('https://raw.githubusercontent.com/selfhst/icons/main/index.json').then(res => res.json()).then(data => { iconDatabase = Object.values(data); });
        
        document.getElementById('icon-search').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const res = document.getElementById('icon-results');
            res.innerHTML = ''; if(q.length < 1) return;
            iconDatabase.filter(i => (i.Name || "").toLowerCase().includes(q) || (i.Reference || "").toLowerCase().includes(q)).slice(0, 12).forEach(i => {
                const name = i.Reference || i.Name;
                const div = document.createElement('div');
                div.className = 'icon-opt';
                div.innerHTML = `<img src="https://raw.githubusercontent.com/selfhst/icons/main/webp/${name}.webp" class="w-8 h-8 object-contain">`;
                div.onclick = () => { document.getElementById('form-icon-val').value = name; document.getElementById('icon-search').value = name; };
                res.appendChild(div);
            });
        });

        function openModal(mode, data = null) {
            const form = document.getElementById('modal-form');
            form.reset();
            document.getElementById('icon-results').innerHTML = '';
            if (mode === 'edit') {
                form.action = "/edit-bookmark";
                document.getElementById('form-id').value = data.id;
                document.getElementById('form-title').value = data.title;
                document.getElementById('form-url').value = data.url;
                document.getElementById('form-icon-val').value = data.icon;
                document.getElementById('icon-search').value = data.icon;
            } else { form.action = "/add-bookmark"; }
            document.getElementById('modal').classList.remove('hidden');
        }
        
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
