<!DOCTYPE html>
<html lang="{{.User.Language}}" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodigoSH | Setup Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/i18n/i18n.js"></script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        html.dark body { 
            background: #0a0a0a; 
        }
        
        html:not(.dark) body { 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
            color: #0f172a; 
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.3;
        }

        .bg-gradient {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            animation: float 15s infinite ease-in-out;
        }

        .gradient-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(239, 68, 68, 0.4) 0%, transparent 70%);
            top: -150px;
            left: -100px;
        }

        .gradient-2 {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, rgba(185, 28, 28, 0.3) 0%, transparent 70%);
            bottom: -100px;
            right: -50px;
            animation-delay: 5s;
        }

        /* Progress bar - separated */
        .progress-bar-wrapper {
            position: relative;
            z-index: 10;
            width: 100%;
            background: rgba(15, 15, 17, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding: 2rem 0;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        html:not(.dark) .progress-bar-wrapper {
            background: rgba(255, 255, 255, 0.5);
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        .progress-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .progress-track {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .progress-line {
            position: absolute;
            top: 18px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: rgba(255, 255, 255, 0.08);
            z-index: 0;
        }

        html:not(.dark) .progress-line {
            background: rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
        }

        .step-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 20%;
        }

        .step-indicator {
            position: relative;
            z-index: 2;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #0f0f11;
            border: 2px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            color: #64748b;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 0 4px #0f0f11;
        }

        html:not(.dark) .step-indicator {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 0 0 4px #ffffff;
        }

        .step-indicator.active {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            color: white;
            box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.12), 0 4px 12px rgba(239, 68, 68, 0.5);
            transform: scale(1.15);
        }

        .step-indicator.completed {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
            color: #ef4444;
            transform: scale(1.05);
        }

        .step-indicator.completed::before {
            content: '‚úì';
        }

        .step-label {
            margin-top: 0.5rem;
            font-size: 0.55rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s;
            text-align: center;
            max-width: 100px;
            line-height: 1.1;
            word-wrap: break-word;
        }

        .step-label.active {
            color: #ef4444;
        }

        /* Main content area */
        .setup-wrapper {
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }

        /* Setup container */
        .setup-container {
            width: 100%;
            max-width: 760px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
        }

        .setup-card {
            background: rgba(15, 15, 17, 0.9);
            backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.05),
                0 20px 60px -10px rgba(0, 0, 0, 0.6),
                0 10px 30px -10px rgba(239, 68, 68, 0.5);
            overflow: visible;
        }

        html:not(.dark) .setup-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.03),
                0 20px 60px -10px rgba(0, 0, 0, 0.2),
                0 10px 30px -10px rgba(239, 68, 68, 0.3);
        }

        /* Logo & Header */
        .wizard-header {
            text-align: center;
            padding: 1.5rem 2rem;
        }

        .logo {
            width: 52px;
            height: 52px;
            margin: 0 auto 0.75rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.625rem;
            font-weight: 900;
            color: white;
            box-shadow: 0 8px 20px -4px rgba(239, 68, 68, 0.6);
        }

        .brand-name {
            font-size: 1.375rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        /* Step content */
        .wizard-content {
            padding: 1.5rem 2rem 2rem 2rem;
            min-height: 280px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        .step-title {
            font-size: 1.125rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .step-desc {
            font-size: 0.8125rem;
            color: #94a3b8;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        html:not(.dark) .step-desc {
            color: #64748b;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #cbd5e1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        html:not(.dark) .form-label {
            color: #475569;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1.5px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #ffffff;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html:not(.dark) .form-input {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.1);
            color: #0f172a;
        }

        .form-input:focus {
            background: rgba(239, 68, 68, 0.05);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.08);
            transform: translateY(-1px);
        }

        .form-input::placeholder {
            color: #64748b;
        }

        /* Language dropdown */
        .language-dropdown {
            position: relative;
            margin-bottom: 1rem;
            width: 100%;
        }

        .dropdown-selected {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.04);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.6rem;
            font-size: 0.9375rem;
            font-weight: 600;
            color: #ffffff;
        }

        html:not(.dark) .dropdown-selected {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.1);
            color: #0f172a;
        }

        .dropdown-selected:hover {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
            transform: translateY(-1px);
        }

        .dropdown-selected.open {
            border-color: rgba(239, 68, 68, 0.4);
            background: rgba(239, 68, 68, 0.08);
        }

        .dropdown-arrow {
            display: none;
        }

        .dropdown-selected.open .dropdown-arrow {
            transform: rotate(180deg);
            color: #ef4444;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: rgba(15, 15, 17, 0.98);
            backdrop-filter: blur(40px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.05);
            max-height: 360px;
            overflow-y: auto;
            z-index: 100;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            bottom: auto;
            overscroll-behavior: contain;
        }

        html:not(.dark) .dropdown-menu {
            background: rgba(255, 255, 255, 0.98);
            border-color: rgba(0, 0, 0, 0.08);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        .dropdown-menu.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.3);
            border-radius: 10px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        .dropdown-option {
            padding: 0.875rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9375rem;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        html:not(.dark) .dropdown-option {
            border-bottom-color: rgba(0, 0, 0, 0.04);
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: rgba(239, 68, 68, 0.08);
            color: #ef4444;
        }

        .dropdown-option.selected {
            background: rgba(239, 68, 68, 0.12);
            color: #ef4444;
            font-weight: 600;
        }

        .dropdown-option .flag {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        /* Avatar upload */
        .avatar-section {
            text-align: center;
            margin-bottom: 1.25rem;
        }

        /* Account step grid */
        .account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            align-items: center;
        }

        .account-grid .avatar-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 1rem;
        }

        html:not(.dark) .account-grid .avatar-card {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.06);
        }

        @media (max-width: 640px) {
            .account-grid {
                grid-template-columns: 1fr;
            }
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 0.875rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 900;
            color: white;
            box-shadow: 0 12px 24px -6px rgba(239, 68, 68, 0.5);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .avatar-preview:hover {
            transform: scale(1.05);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #cbd5e1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        /* Theme selection */
        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .theme-card {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.04);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        html:not(.dark) .theme-card {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.1);
        }

        .theme-card:hover {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }

        .theme-card.selected {
            background: rgba(239, 68, 68, 0.12);
            border-color: #ef4444;
        }

        .theme-card-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .theme-card-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #cbd5e1;
        }

        html:not(.dark) .theme-card-label {
            color: #475569;
        }

        /* Error message - Toast notification */
        .error-alert {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            padding: 1rem 1.25rem;
            background: rgba(220, 38, 38, 0.95);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 12px;
            color: #ffffff;
            font-size: 0.875rem;
            font-weight: 500;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(239, 68, 68, 0.3);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .error-alert.show {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
        }

        @media (max-width: 640px) {
            .error-alert {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }

        /* Action buttons */
        .wizard-actions {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        html:not(.dark) .wizard-actions {
            border-top-color: rgba(0, 0, 0, 0.05);
        }

        .btn {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
        }

        html:not(.dark) .btn-back {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(0, 0, 0, 0.1);
            color: #475569;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .btn-next {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 20px -4px rgba(239, 68, 68, 0.6);
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px -6px rgba(239, 68, 68, 0.8);
        }

        .btn-next:active {
            transform: translateY(0);
        }

        /* Password toggle */
        .input-wrapper {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: #ef4444;
        }

        @media (max-width: 480px) {
            .setup-container {
                max-width: 100%;
            }
            
            .wizard-content {
                padding: 1.25rem 1.5rem 1.5rem 1.5rem;
            }

            .progress-container {
                padding: 0 1rem;
            }

            .step-label {
                max-width: 70px;
                font-size: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Error message toast (fixed position) -->
    <div class="error-alert" id="errorAlert"></div>

    <!-- Animated background -->
    <div class="bg-animation">
        <div class="bg-gradient gradient-1"></div>
        <div class="bg-gradient gradient-2"></div>
    </div>

    <!-- Progress bar - SEPARATED FROM MODAL -->
    <div class="progress-bar-wrapper">
        <div class="progress-container">
            <div class="progress-track">
                <div class="progress-line">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="step-wrapper">
                    <div class="step-indicator active" data-step="1">1</div>
                    <div class="step-label active" data-i18n="setup.stepLanguage">Language</div>
                </div>
                <div class="step-wrapper">
                    <div class="step-indicator" data-step="2">2</div>
                    <div class="step-label" data-i18n="setup.stepAccount">Account</div>
                </div>
                <div class="step-wrapper">
                    <div class="step-indicator" data-step="3">3</div>
                    <div class="step-label" data-i18n="setup.stepSecurity">Security</div>
                </div>
                <div class="step-wrapper">
                    <div class="step-indicator" data-step="4">4</div>
                    <div class="step-label" data-i18n="setup.stepCustomize">Customize</div>
                </div>
                <div class="step-wrapper">
                    <div class="step-indicator" data-step="5">5</div>
                    <div class="step-label" data-i18n="setup.stepComplete">Complete</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="setup-wrapper">
        <!-- Setup wizard -->
        <div class="setup-container">
            <div class="setup-card">
                <!-- Header -->
                <div class="wizard-header">
                    <div class="logo">K</div>
                    <div class="brand-name">CodigoSH</div>
                </div>

                <!-- Wizard form -->
                <form id="setupForm" method="POST" action="/setup" enctype="multipart/form-data">
                    <!-- Content area -->
                    <div class="wizard-content">
                        <!-- Step 1: Language -->
                        <div class="wizard-step active" data-step="1">
                            <h2 class="step-title" data-i18n="setup.chooseLanguage">üåç Choose Your Language</h2>
                            <p class="step-desc" data-i18n="setup.languageDesc">This will be used throughout the application</p>
                            <div class="form-group">
                                <div class="language-dropdown">
                                    <div class="dropdown-selected" id="dropdownSelected">
                                        <span id="selectedLangText">üá∫üá∏ English</span>
                                        <span class="dropdown-arrow">‚ñº</span>
                                    </div>
                                    <div class="dropdown-menu" id="dropdownMenu">
                                        <div class="dropdown-option selected" data-lang="en" data-text="üá∫üá∏ English"><span class="flag">üá∫üá∏</span> English</div>
                                        <div class="dropdown-option" data-lang="es" data-text="üá™üá∏ Espa√±ol"><span class="flag">üá™üá∏</span> Espa√±ol</div>
                                        <div class="dropdown-option" data-lang="fr" data-text="üá´üá∑ Fran√ßais"><span class="flag">üá´üá∑</span> Fran√ßais</div>
                                        <div class="dropdown-option" data-lang="de" data-text="üá©üá™ Deutsch"><span class="flag">üá©üá™</span> Deutsch</div>
                                        <div class="dropdown-option" data-lang="it" data-text="üáÆüáπ Italiano"><span class="flag">üáÆüáπ</span> Italiano</div>
                                        <div class="dropdown-option" data-lang="pt" data-text="üáµüáπ Portugu√™s"><span class="flag">üáµüáπ</span> Portugu√™s</div>
                                        <div class="dropdown-option" data-lang="ru" data-text="üá∑üá∫ –†—É—Å—Å–∫–∏–π"><span class="flag">üá∑üá∫</span> –†—É—Å—Å–∫–∏–π</div>
                                        <div class="dropdown-option" data-lang="zh" data-text="üá®üá≥ ‰∏≠Êñá"><span class="flag">üá®üá≥</span> ‰∏≠Êñá</div>
                                        <div class="dropdown-option" data-lang="ja" data-text="üáØüáµ Êó•Êú¨Ë™û"><span class="flag">üáØüáµ</span> Êó•Êú¨Ë™û</div>
                                        <div class="dropdown-option" data-lang="ko" data-text="üá∞üá∑ ÌïúÍµ≠Ïñ¥"><span class="flag">üá∞üá∑</span> ÌïúÍµ≠Ïñ¥</div>
                                        <div class="dropdown-option" data-lang="ar" data-text="üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"><span class="flag">üá∏üá¶</span> ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                                        <div class="dropdown-option" data-lang="hi" data-text="üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä"><span class="flag">üáÆüá≥</span> ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                                        <div class="dropdown-option" data-lang="nl" data-text="üá≥üá± Nederlands"><span class="flag">üá≥üá±</span> Nederlands</div>
                                        <div class="dropdown-option" data-lang="sv" data-text="üá∏üá™ Svenska"><span class="flag">üá∏üá™</span> Svenska</div>
                                        <div class="dropdown-option" data-lang="pl" data-text="üáµüá± Polski"><span class="flag">üáµüá±</span> Polski</div>
                                        <div class="dropdown-option" data-lang="tr" data-text="üáπüá∑ T√ºrk√ße"><span class="flag">üáπüá∑</span> T√ºrk√ße</div>
                                        <div class="dropdown-option" data-lang="vi" data-text="üáªüá≥ Ti·∫øng Vi·ªát"><span class="flag">üáªüá≥</span> Ti·∫øng Vi·ªát</div>
                                        <div class="dropdown-option" data-lang="th" data-text="üáπüá≠ ‡πÑ‡∏ó‡∏¢"><span class="flag">üáπüá≠</span> ‡πÑ‡∏ó‡∏¢</div>
                                        <div class="dropdown-option" data-lang="id" data-text="üáÆüá© Bahasa"><span class="flag">üáÆüá©</span> Bahasa</div>
                                        <div class="dropdown-option" data-lang="el" data-text="üá¨üá∑ ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨"><span class="flag">üá¨üá∑</span> ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</div>
                                    </div>
                                </div>
                                <input type="hidden" name="language" id="languageInput" value="en">
                            </div>
                        </div>

                        <!-- Step 2: Account (Name & Avatar) -->
                        <div class="wizard-step" data-step="2">
                            <h2 class="step-title" data-i18n="setup.createAccount">üë§ Create Admin Account</h2>
                            <p class="step-desc" data-i18n="setup.accountDesc">Set up your administrator profile</p>

                            <div class="account-grid">
                                <div class="avatar-card">
                                    <div class="avatar-section" style="margin-bottom: 0;">
                                        <div class="avatar-preview" id="avatarPreview">
                                            <span id="avatarInitial">K</span>
                                        </div>
                                        <label class="avatar-upload-label" data-i18n="setup.avatar">Avatar</label>
                                        <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display:none;">
                                        <p class="step-desc" style="margin-top: 0.5rem;" data-i18n="setup.avatarDesc">Add a profile picture (optional)</p>
                                    </div>
                                </div>

                                <div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label class="form-label" data-i18n="setup.username">Username</label>
                                        <input type="text" name="username" id="username" class="form-input" placeholder="Choose a username" data-i18n-placeholder="setup.usernamePlaceholder" required minlength="3">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Security (Password) -->
                        <div class="wizard-step" data-step="3">
                            <h2 class="step-title" data-i18n="setup.securityTitle">üîí Security</h2>
                            <p class="step-desc" data-i18n="setup.securityDesc">Set a secure administrator password</p>
                            <div class="form-group">
                                <label class="form-label" data-i18n="setup.password">Password</label>
                                <div class="input-wrapper">
                                    <input type="password" name="password" id="password" class="form-input" placeholder="Create a secure password" data-i18n-placeholder="setup.passwordPlaceholder" required minlength="6">
                                    <button type="button" class="password-toggle">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="setup.confirmPassword">Confirm Password</label>
                                <div class="input-wrapper">
                                    <input type="password" name="password_confirm" id="confirmPassword" class="form-input" placeholder="Confirm your password" data-i18n-placeholder="setup.confirmPasswordPlaceholder" required minlength="6">
                                    <button type="button" class="password-toggle">üëÅÔ∏è</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Theme -->
                        <div class="wizard-step" data-step="4">
                            <h2 class="step-title" data-i18n="setup.personalize">üé® Personalize</h2>
                            <p class="step-desc" data-i18n="setup.personalizeDesc">Choose your theme</p>
                            <div class="form-group">
                                <label class="form-label" data-i18n="setup.chooseTheme">Choose Theme</label>
                                <div class="theme-grid">
                                    <div class="theme-card selected" data-theme="dark">
                                        <div class="theme-card-icon">üåô</div>
                                        <div class="theme-card-label" data-i18n="setup.themeDark">Dark</div>
                                    </div>
                                    <div class="theme-card" data-theme="light">
                                        <div class="theme-card-icon">‚òÄÔ∏è</div>
                                        <div class="theme-card-label" data-i18n="setup.themeLight">Light</div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="theme" id="themeInput" value="dark">
                        </div>

                        <!-- Step 5: Review & Complete -->
                        <div class="wizard-step" data-step="5">
                            <h2 class="step-title" data-i18n="setup.allSet">‚ú® All Set!</h2>
                            <p class="step-desc" data-i18n="setup.reviewSetup">Review your setup and complete the installation</p>
                            <div style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 1rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Language</div>
                                        <div id="summaryLanguage" style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem;">English</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Username</div>
                                        <div id="summaryUsername" style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem;">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Theme</div>
                                        <div id="summaryTheme" style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem;">Dark</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Avatar</div>
                                        <div id="summaryAvatar" style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem;">Default</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation buttons -->
                    <div class="wizard-actions">
                        <button type="button" class="btn btn-back" id="backBtn" style="display:none;">
                            <span data-i18n="setup.back">‚Üê Back</span>
                        </button>
                        <button type="button" class="btn btn-next" id="nextBtn">
                            <span data-i18n="setup.next">Next ‚Üí</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 1;
            const totalSteps = 5;
            const languageLabels = {
                en: 'English', es: 'Espa√±ol', fr: 'Fran√ßais', de: 'Deutsch',
                it: 'Italiano', pt: 'Portugu√™s', ru: '–†—É—Å—Å–∫–∏–π', zh: '‰∏≠Êñá',
                ja: 'Êó•Êú¨Ë™û', ko: 'ÌïúÍµ≠Ïñ¥', ar: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', hi: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',
                nl: 'Nederlands', sv: 'Svenska', pl: 'Polski', tr: 'T√ºrk√ße',
                vi: 'Ti·∫øng Vi·ªát', th: '‡πÑ‡∏ó‡∏¢', id: 'Bahasa', el: 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨'
            };

            // Language dropdown
            const dropdownSelected = document.getElementById('dropdownSelected');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const selectedLangText = document.getElementById('selectedLangText');
            const languageInput = document.getElementById('languageInput');

            // Load saved language on init and sync UI
            const hasUserSelection = localStorage.getItem('languageSelected') === 'true';
            const savedLanguage = hasUserSelection ? (localStorage.getItem('language') || localStorage.getItem('selectedLanguage')) : null;
            const initialLanguage = savedLanguage || 'en';
            if (languageInput) languageInput.value = initialLanguage;
            const savedOption = dropdownMenu ? dropdownMenu.querySelector(`.dropdown-option[data-lang="${initialLanguage}"]`) : null;
            if (savedOption && selectedLangText) {
                selectedLangText.textContent = savedOption.dataset.text;
                document.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                savedOption.classList.add('selected');
            }
            if (window.i18n) {
                window.i18n.currentLanguage = initialLanguage;
                window.i18n.loadLanguage(initialLanguage).then(() => {
                    window.i18n.updatePageLanguage();
                    updateProgress();
                });
            }
            
            if (dropdownSelected && dropdownMenu) {
                dropdownSelected.addEventListener('click', function(e) {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('open');
                    dropdownSelected.classList.toggle('open');
                    
                    if (dropdownMenu.classList.contains('open')) {
                        setTimeout(() => {
                            const rect = dropdownSelected.getBoundingClientRect();
                            const dropdownHeight = dropdownMenu.offsetHeight;
                            const spaceBelow = window.innerHeight - rect.bottom;
                            const spaceAbove = rect.top;
                            
                            // Siempre mostrar desde el inicio
                            dropdownMenu.scrollTop = 0;
                            
                            // Determina si abre hacia arriba o abajo
                            if (spaceBelow < dropdownHeight + 20 && spaceAbove > dropdownHeight + 20) {
                                // Abre hacia arriba
                                dropdownMenu.style.top = 'auto';
                                dropdownMenu.style.bottom = 'calc(100% + 0.5rem)';
                            } else {
                                // Abre hacia abajo (por defecto)
                                dropdownMenu.style.top = 'calc(100% + 0.5rem)';
                                dropdownMenu.style.bottom = 'auto';
                            }
                        }, 0);
                    }
                });

                document.querySelectorAll('.dropdown-option').forEach(option => {
                    option.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const lang = this.dataset.lang;
                        const text = this.dataset.text;
                        
                        selectedLangText.textContent = text;
                        languageInput.value = lang;
                        
                        document.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        dropdownMenu.classList.remove('open');
                        dropdownSelected.classList.remove('open');
                        
                        const i18nInstance = window.i18n || window.parent?.i18n || i18n;
                        if (i18nInstance) {
                            // Update language for UI only (don't persist yet)
                            i18nInstance.currentLanguage = lang;
                            i18nInstance.loadLanguage(lang).then(() => {
                                i18nInstance.updatePageLanguage();
                                updateProgress();
                            }).catch(() => {
                                i18nInstance.updatePageLanguage();
                                updateProgress();
                            });
                        }
                    });
                });

                document.addEventListener('click', function(e) {
                    if (!dropdownSelected.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        dropdownMenu.classList.remove('open');
                        dropdownSelected.classList.remove('open');
                    }
                });
            }

            // Theme selection with real-time preview
            document.querySelectorAll('.theme-card').forEach(card => {
                card.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('themeInput').value = theme;
                    
                    // Apply theme instantly for feedback
                    const html = document.documentElement;
                    if (theme === 'light') {
                        html.classList.remove('dark');
                    } else {
                        html.classList.add('dark');
                    }
                });
            });

            // Avatar preview
            function previewAvatar(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('avatarPreview');
                        preview.innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            const avatarInput = document.getElementById('avatarInput');
            if (avatarInput) {
                avatarInput.addEventListener('change', previewAvatar);
            }
            
            const avatarPreview = document.getElementById('avatarPreview');
            if (avatarPreview) {
                avatarPreview.addEventListener('click', function() {
                    if (avatarInput) avatarInput.click();
                });
            }

            document.getElementById('username').addEventListener('input', function() {
                const initial = this.value.charAt(0).toUpperCase() || 'K';
                const avatarInitial = document.getElementById('avatarInitial');
                if (avatarInitial) {
                    avatarInitial.textContent = initial;
                }
            });

            // Password toggle
            document.querySelectorAll('.password-toggle').forEach((btn) => {
                btn.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    if (input) {
                        input.type = input.type === 'password' ? 'text' : 'password';
                    }
                });
            });

            // Navigation
            function updateProgress() {
                const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    indicator.classList.remove('active', 'completed');
                    if (index + 1 < currentStep) {
                        indicator.classList.add('completed');
                    } else if (index + 1 === currentStep) {
                        indicator.classList.add('active');
                    }
                });

                document.querySelectorAll('.step-label').forEach((label, index) => {
                    label.classList.toggle('active', index + 1 === currentStep);
                });

                document.querySelectorAll('.wizard-step').forEach((step, index) => {
                    step.classList.toggle('active', index + 1 === currentStep);
                });

                document.getElementById('backBtn').style.display = currentStep === 1 ? 'none' : 'block';
                const nextBtn = document.getElementById('nextBtn');
                const nextBtnText = nextBtn.querySelector('span');
                if (currentStep === totalSteps) {
                    nextBtnText.setAttribute('data-i18n', 'setup.complete');
                    nextBtnText.textContent = window.i18n ? window.i18n.t('setup.complete') : 'Complete Setup ‚úì';
                } else {
                    nextBtnText.setAttribute('data-i18n', 'setup.next');
                    nextBtnText.textContent = window.i18n ? window.i18n.t('setup.next') : 'Next ‚Üí';
                }
            }

            function getErrorMessage(errorKey) {
                return window.i18n ? window.i18n.t(`setup.${errorKey}`) : `Error: ${errorKey}`;
            }

            function showErrorToast(message) {
                const errorAlert = document.getElementById('errorAlert');
                errorAlert.textContent = message;
                errorAlert.classList.add('show');
                clearTimeout(window.errorTimeout);
                window.errorTimeout = setTimeout(() => {
                    errorAlert.classList.remove('show');
                }, 5000);
            }

            function validateStep() {
                clearTimeout(window.errorTimeout);

                if (currentStep === 2) {
                    const username = document.getElementById('username').value.trim();

                    if (username.length < 3) {
                        showErrorToast(getErrorMessage('errorUsernameShort'));
                        return false;
                    }
                }

                if (currentStep === 3) {
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (password.length < 6) {
                        showErrorToast(getErrorMessage('errorPasswordShort'));
                        return false;
                    }

                    if (password !== confirmPassword) {
                        showErrorToast(getErrorMessage('errorPasswordMismatch'));
                        return false;
                    }
                }

                return true;
            }

            function updateSummary() {
                const lang = document.getElementById('languageInput').value;
                document.getElementById('summaryLanguage').textContent = languageLabels[lang] || lang;
                document.getElementById('summaryUsername').textContent = document.getElementById('username').value || '-';
                document.getElementById('summaryTheme').textContent = document.getElementById('themeInput').value === 'dark' ? 'Dark' : 'Light';
                document.getElementById('summaryAvatar').textContent = document.getElementById('avatarInput').files.length > 0 ? 'Custom' : 'Default';
            }

            function nextStep() {
                if (!validateStep()) return;

                if (currentStep === totalSteps) {
                    // Persist language selection before submitting
                    const selectedLang = document.getElementById('languageInput').value;
                    if (window.i18n && window.i18n.persistLanguage) {
                        window.i18n.persistLanguage(selectedLang);
                    }
                    document.getElementById('setupForm').submit();
                    return;
                }

                if (currentStep === 4) {
                    updateSummary();
                }

                currentStep++;
                updateProgress();
            }

            function previousStep() {
                if (currentStep > 1) {
                    currentStep--;
                    updateProgress();
                }
            }

            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('backBtn').addEventListener('click', previousStep);

            updateProgress();
        });
    </script>
</body>
</html>
